name: Setup Docker workflow
description: Shared steps for Docker builds and tests.
inputs:
  registry-token:
    description: Token used to authenticate against the container registry. Optional â€” if not provided the login step will be skipped.
    required: false
    default: ''
outputs:
  image_base:
    description: Base image name used for GHCR publishes.
    value: ${{ steps.image_base.outputs.IMAGE_BASE }}
  tags:
    description: Tags generated by docker/metadata-action.
    value: ${{ steps.meta.outputs.tags }}
  labels:
    description: Labels generated by docker/metadata-action.
    value: ${{ steps.meta.outputs.labels }}
runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set IMAGE_BASE
      id: image_base
      shell: bash
      run: echo "IMAGE_BASE=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ steps.image_base.outputs.IMAGE_BASE }}

    - name: Login to GitHub Container Registry
      if: ${{ inputs.registry-token != '' }}
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.registry-token }}
